<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="calculator.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="common.js"></script>
    <title>계산기</title>
  </head>
  <script>
    //숫자 정규식
    const numberCheck = /[0-9]/;

    function numberPress(val) {
      let keyCode = event.keyCode;
      let key = event.key;
      const textCheck = /[a-z|ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/g;

      console.log(keyCode + " = key ");
      //shift, ctrl은 press event 적용안함.
      //48~57 : 숫자, 8 : 백스페이스, 13 : 엔터, 46 : 딜리트, / : 191, * : 56, - :189, + : 187, = : 187
      if((keyCode >= 48 && keyCode <= 57) || 
          (keyCode == 8 || keyCode == 13 || keyCode == 46 || keyCode == 191 || keyCode == 56 || keyCode == 189 || keyCode == 187)) {
            console.log(keyCode + " = key2 ");
            
        jQuery.pressHoverEvent(key);

        event.preventDefault();
        
        return false;
      }

      //shift : 16, shift : 17
      if(textCheck.test(key) && keyCode != 16 && keyCode != 17){
        //숫자와 연산자 이외 입력시, alert처리
        alert("숫자 및 연산자 이외 입력이 불가합니다. 숫자와 연산자만 입력바랍니다.");
        
        //keydown시 input data가 지워지지 않아 setTimeout 사용.
        //keyup의 경우, 숫자 입력시 2번씩 입력되는 오류가 있음.
        setTimeout(function () {
          //input창 지우기
          $('#input_window').val("");
        }, 50);

        event.preventDefault();

        return false;
      }
    }

    //연산식이 올바르지 않을때, == 연산식이 연산자로 끝나는 경우
    function iscorrectlyCal(record, data) {
      return !numberCheck.test(record.charAt(record.length - 1)) && data === "=";
    }

    //합계 버튼 클릭시,
    function getResult(record, data) {
      return numberCheck.test(record.substring(0, record.length - 1)) && data === "=";
    }


    //button click event
    function add(data) {
      //input창에 입력된 데이터
      let inputValue = $("#input_window").val();

      //record data
      let record = $("#record").text();

      //기호문자를 가장 먼저 입력했을때,
      if (!record && !numberCheck.test(data)) {
        alert("숫자를 먼저 입력해주세요.");

        return false;
      }

      //가장 처음 숫자 입력시, == 새로온 record div 생성시,
      if (!record && numberCheck.test(data)) {
      //record 기록이 10개인 경우, 제일 먼저 입력한 기록값 삭제 후 기록
      if ($("#result_record div").length == 11) {
      $("#result_record div:eq(0)").remove();
      }

      $("#record").text(record + data);
      $("#input_window").val(inputValue + data);

      return false;
      }

      //숫자 입력시,
      if(numberCheck.test(data)) {
        $("#record").text(record + data);
        $("#input_window").val(inputValue + data);

        return false;
      }

      //data가 del이 아닌 연산자인 경우,
      if(record && !numberCheck.test(data) && data != 'del' && data != '=') {
        // 앞뒤로 공백 추가   
        record = record + " " + data + " ";

        //공백 + 기호문자
        $("#record").text(record);

        //기호문자 입력 후 input 창 지우기
        $("#input_window").val("");

        return false;
      }

      //연산식이 기호로 끝났을때 == 연산식이 올바르지 않을때,
      if (iscorrectlyCal(record, data)) {
        alert("계산식이 올바르지 않습니다. 다시 입력해주세요.");

        return false;
      }
      
      //연산자 연속입력시, 마지막 연산자 입력되게 함.
      if (record && !inputValue && !numberCheck.test(data)) {
        let delOper = record.substring(0, record.length - 2);
        $("#record").text(delOper + " " + data + " ");

        return false;
      }
      
       //record에 기록이 존재하고, reset 버튼을 눌렀을때
      if (data === 'del' && record.length > 0) {
        //input 창에서 data delete
        // if(inputValue.length > 0) {
          $("#input_window").val("");
        // }

        //record data 삭제
        record = null;

        //$("#record").text() 삭제
        $("#record").text("");

        return false;
      }


      //계산버튼 클릭시,
      if (getResult(record, data)) {
        //공백 기준으로 글자 자르기
        let arr = $("#record").text().split(" ");

        //첫번째 데이터
        cal = arr[0] * 1;

        for (let i = 1; i < arr.length; i++) {
          if (arr[i] === "+") {
            cal += arr[i + 1] * 1;
          } else if (arr[i] === "-") {
            cal -= arr[i + 1] * 1;
          } else if (arr[i] === "/") {
            cal /= arr[i + 1] * 1;
          } else if (arr[i] === "*") {
            cal *= arr[i + 1] * 1;
          } else {
            continue;
          }
        }

        //결과값이 소수점일때, 소수 2번째자리까지만 출력
        if (!Number.isInteger(cal)) {
          cal = cal.toFixed(2);
        }

        //계산식 결과 input창에 출력
        $("#input_window").val(cal);

        //계산식 전체 record에 기록
        let resultRecord = record + " " + data + " " + cal;
        $("#record").text(resultRecord);

        //기존의 record div id 삭제
        document.querySelector("#record").removeAttribute("id");

        //record용 div 생성 및 id 부여
        let newRecord = $("#result_record").append("<div id='record'></div>");

        $("#input_window").val("");
        $("#input_window").focus;

        return false;
      }      
    }
    
  </script>
  <body>
    <div id="cal_container">
      <form id="cal_data">
        <input
          type="text"
          id="input_window"
          minlength="3"
          maxlength="11"
          onkeydown="numberPress(event);"
        />
        <div>
          <button type="button" id="num_7" onclick="add(7)">7</button>
          <button type="button" id="num_8" onclick="add(8)">8</button>
          <button type="button" id="num_9" onclick="add(9)">9</button>
          <button type="button" id="num_47" onclick="add('/')">/</button>
        </div>
        <div>
          <button type="button" id="num_4" onclick="add(4)">4</button>
          <button type="button" id="num_5" onclick="add(5)">5</button>
          <button type="button" id="num_6" onclick="add(6)">6</button>
          <button type="button" id="num_42" onclick="add('*')">*</button>
        </div>
        <div>
          <button type="button" id="num_1" onclick="add(1)">1</button>
          <button type="button" id="num_2" onclick="add(2)">2</button>
          <button type="button" id="num_3" onclick="add(3)">3</button>
          <button type="button" id="num_45" onclick="add('-')">-</button>
        </div>
        <div>
          <button type="button" id="num_127" onclick="add('del')">C</button>
          <button type="button" id="num_0" onclick="add(0)">0</button>
          <button type="button" id="num_61" onclick="add('=')">=</button>
          <button type="button" id="num_43" onclick="add('+')">+</button>
        </div>
      </form>
    </div>
    <div id="result_record" style="font-size: 50px">
      <div id="record"></div>
    </div>
  </body>

</html>
